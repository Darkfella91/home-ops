# yaml-language-server: $schema=https://raw.githubusercontent.com/goauthentik/authentik/refs/heads/main/blueprints/schema.json
version: 1
metadata:
  name: Notification Rule - Configuration Error
context:
  group_name: null
  notify_email: true
  notify_local: true
entries:
- model: authentik_blueprints.metaapplyblueprint
  identifiers:
      name: Notification Transport - Email
  attrs:
    required: true

- model: authentik_blueprints.metaapplyblueprint
  identifiers:
      name: Notification Transport - Local
  attrs:
    required: true

- model: authentik_blueprints.metaapplyblueprint
  identifiers:
      name: Event Matcher Policy - Configuration Error
  attrs:
    required: true

- model: authentik_events.notificationrule
  id: configuration-error-notification-rule
  identifiers:
    name: configuration-error-notification-rule
  attrs:
    severity: alert
    group: !If [
      !Condition [OR, !Context notify_email, !Context notify_local],
      !If [
        !Context group_name,
        !Find [authentik_core.group, [name, !Context group_name]],
        !Find [authentik_core.group, [attributes__contains, {better-blueprints/id: default-admins-group}]]
      ],
      null
    ]
    transports:
      - notify_local
      - notify_email

- model: authentik_policies.policybinding
  identifiers:
    policy: !Find [authentik_policies_event_matcher.eventmatcherpolicy, [name, configuration-error-event-matcher-policy]]
    target: !KeyOf configuration-error-notification-rule
  attrs:
    order: 100
    enabled: true
    timeout: 30
